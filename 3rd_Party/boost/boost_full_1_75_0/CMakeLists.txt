CMAKE_MINIMUM_REQUIRED(VERSION 3.1)
CMAKE_POLICY(VERSION 3.1)
PROJECT(boost_full)

INCLUDE($ENV{MK_PATH}/make/begin.cmake)

SET(TARGET_TYPE LIBRARY)
SET(TARGET_NAME boost_full)

set(BOOST_ROOT ./boost_1_75_0)

INCLUDE_DIRECTORIES(${BOOST_ROOT})

IF(WIN32)
    ADD_DEFINITIONS("-DBOOST_USE_WINDOWS_H")
    # windows下强制生成.lib文件,否则无法被link
    ADD_DEFINITIONS("-D__MAKE_MK_DLL__")
    #set(MK_BUILD_SOURCE_FILES ${MK_BUILD_SOURCE_FILES} boost_full.cpp)
ENDIF()

#公共宏
set(MK_DEFINITIONS_PUBLIC ${MK_DEFINITIONS_PUBLIC}  BOOST_ALL_NO_LIB BOOST_ALL_DYN_LINK)
set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_LIB_DIAGNOSTIC BOOST_THREAD_BUILD_DLL=1 BOOST_SYSTEM_NO_DEPRECATED)

#atomic
set(MK_DEFINITIONS_PUBLIC ${MK_DEFINITIONS_PUBLIC} BOOST_ATOMIC_NO_LIB BOOST_ATOMIC_DYN_LINK)
set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_ATOMIC_SOURCE)
INCLUDE_DIRECTORIES(${BOOST_ROOT}/libs/atomic/src)
IF(UNIX)
    set(MK_BUILD_SOURCE_FILES ${MK_BUILD_SOURCE_FILES} ${BOOST_ROOT}/libs/atomic/src/lock_pool.cpp)
ELSE()
    set(MK_BUILD_SOURCE_FILES ${MK_BUILD_SOURCE_FILES} ${BOOST_ROOT}/libs/atomic/src/lock_pool.cpp)
    set(MK_BUILD_SOURCE_FILES ${MK_BUILD_SOURCE_FILES} ${BOOST_ROOT}/libs/atomic/src/wait_ops_windows.cpp)
ENDIF()

#chrono
set(MK_DEFINITIONS_PUBLIC ${MK_DEFINITIONS_PUBLIC} BOOST_CHRONO_NO_LIB BOOST_CHRONO_DYN_LINK)
set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_CHRONO_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/chrono/src)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/chrono/src)
ENDIF()

#container
set(MK_DEFINITIONS_PUBLIC ${MK_DEFINITIONS_PUBLIC} BOOST_CONTAINER_NO_LIB)
set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_CONTAINER_SOURCE)
file( GLOB boost_container_cpp_files ${BOOST_ROOT}/libs/container/src/*.cpp)
set(MK_BUILD_SOURCE_FILES ${MK_BUILD_SOURCE_FILES} ${BOOST_ROOT}/libs/container/src/alloc_lib.c ${boost_container_cpp_files})


#context
ADD_DEFINITIONS(-DBOOST_USE_UCONTEXT)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/context/src)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/context/src/posix)
    SET(EXCLUDE_SOURCE_FILES ${EXCLUDE_SOURCE_FILES} ${BOOST_ROOT}/libs/context/src/untested.cpp)
ELSE()
    #TODO
ENDIF()

#contract
ADD_DEFINITIONS(-DBOOST_CONTRACT_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/contract/src)
ELSE()
    #TODO
ENDIF()

#coroutine
ADD_DEFINITIONS(-DBOOST_COROUTINES_SOURCE)
IF(UNIX)
    #todo:暂未解决运行时 undefined reference to `jump_fcontext'
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/coroutine/src)
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/coroutine/src/posix)
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/coroutine/src/detail)
ENDIF()

# date_time
set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_DATE_TIME_SOURCE)
SET(EXCLUDE_SOURCE_FILES ${EXCLUDE_SOURCE_FILES} ${BOOST_ROOT}/libs/date_time/src/greg_month.cpp)
IF(UNIX)
ENDIF()

#exception
ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/exception/src)


#fiber
ADD_DEFINITIONS(-DBOOST_FIBERS_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/fiber/src)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/fiber/src/algo)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/fiber/src/numa/linux)
ELSE()
    #TODO
ENDIF()

#filesystem
set(MK_DEFINITIONS_PUBLIC ${MK_DEFINITIONS_PUBLIC} BOOST_FILESYSTEM_NO_LIB BOOST_FILESYSTEM_DYN_LINK )
set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_FILESYSTEM_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/filesystem/src)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/filesystem/src)
    set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_FILESYSTEM_HAS_STAT_ST_MTIM)
    set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_FILESYSTEM_HAS_STAT_ST_MTIMENSEC)
    set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_FILESYSTEM_HAS_STAT_ST_MTIMESPEC)
    set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_FILESYSTEM_HAS_BCRYPT)
    SET(LINK_CUSTOM_LIBS ${LINK_CUSTOM_LIBS} bcrypt)
ENDIF()

#graph
ADD_DEFINITIONS(-DBOOST_GRAPH_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/graph/src)
ELSE()
    #依赖 boost::regex 库
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/graph/src)
ENDIF()

#graph_parallel
IF(UNIX)
    #需要安装mpi:yum -y install openmpi-devel 
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/graph_parallel/src)
    INCLUDE_DIRECTORIES(/usr/include/openmpi-x86_64)
    LINK_DIRECTORIES(/usr/lib64/openmpi/lib)
    SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -lmpi")
ELSE()
    #TODO
ENDIF()

#iostreams
ADD_DEFINITIONS(-DBOOST_IOSTREAMS_SOURCE)
IF(UNIX)
    #需要安装bzip2(zlib.h):yum -y install bzip2-devel
    #需要安装xz(lzma.h): yum -y install xz-devel
    #需要安装zstd(zstd.h): todo
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/iostreams/src)
    
    #todo:暂未安装zstd
    SET(EXCLUDE_SOURCE_FILES ${EXCLUDE_SOURCE_FILES} ${BOOST_ROOT}/libs/iostreams/src/zstd.cpp)
ELSE()
    #TODO
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/iostreams/src)
ENDIF()

#json
set(MK_DEFINITIONS_PUBLIC ${MK_DEFINITIONS_PUBLIC} BOOST_JSON_NO_LIB BOOST_JSON_DYN_LINK )
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/json/src)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/json/src)
ENDIF()

#locale
ADD_DEFINITIONS(-DBOOST_LOCALE_SOURCE)
IF(UNIX)
    #todo:暂未解决链接问题
    #INCLUDE_DIRECTORIES(${BOOST_ROOT}/libs/locale/src)
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/locale/src/encoding)
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/locale/src/posix)
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/locale/src/shared)
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/locale/src/util)
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/locale/src/std)
ENDIF()

#log
IF(UNIX)
    #todo:暂未解决编译问题
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/log/src)
ENDIF()

#math
IF(UNIX)
    #todo:暂未解决编译问题
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/math/src/tr1)
ENDIF()

#mpi
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/mpi/src)
ENDIF()

#nowide
ADD_DEFINITIONS(-DBOOST_NOWIDE_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/nowide/src)
ELSE()
    #TODO
ENDIF()

#program_options
ADD_DEFINITIONS(-DBOOST_PROGRAM_OPTIONS_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/program_options/src)
ELSE()
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/program_options/src)
ENDIF()

#python
IF(UNIX)
    #todo:暂未解决编译问题
ENDIF()

#random 
ADD_DEFINITIONS(-DBOOST_RANDOM_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/random/src)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/random/src)
ENDIF()

#regex
set(MK_DEFINITIONS_PUBLIC ${MK_DEFINITIONS_PUBLIC} BOOST_REGEX_NO_LIB BOOST_REGEX_DYN_LINK )
set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_REGEX_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/regex/src)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/regex/src)
ENDIF()

#serialization
ADD_DEFINITIONS(-DBOOST_ARCHIVE_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/serialization/src)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/serialization/src)
ENDIF()

#stacktrace
IF(UNIX)
    #todo:暂未解决编译问题
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/stacktrace/src)
ENDIF()

#system
ADD_DEFINITIONS(-DBOOST_SYSTEM_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/system/src)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/system/src)
ENDIF()

#test
ADD_DEFINITIONS(-DBOOST_TEST_SOURCE)
IF(UNIX)
    #todo:暂未解决 undefined reference to `test_main(int, char**)'
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/test/src)
ENDIF()

#thread
IF(WIN32)
    #TODO 暂时存在链接问题未解决
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/thread/src)
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/thread/src/win32)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/thread/src)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/thread/src/pthread)
    SET(EXCLUDE_SOURCE_FILES ${EXCLUDE_SOURCE_FILES} ${BOOST_ROOT}/libs/thread/src/pthread/once_atomic.cpp)
ENDIF()

#timer
set(MK_DEFINITIONS_PUBLIC ${MK_DEFINITIONS_PUBLIC} BOOST_TIMER_NO_LIB BOOST_TIMER_DYN_LINK )
set(MK_DEFINITIONS_PRIVATE ${MK_DEFINITIONS_PRIVATE} BOOST_TIMER_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/timer/src)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/timer/src)
ENDIF()

#type_erasure
ADD_DEFINITIONS(-DBOOST_TYPE_ERASURE_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/type_erasure/src)
ELSE()
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/type_erasure/src)
ENDIF()

#wave
ADD_DEFINITIONS(-DBOOST_WAVE_SOURCE)
IF(UNIX)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/wave/src)
    ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/wave/src/cpplexer/re2clex)
ELSE()
    #TODO 暂时存在链接问题未解决
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/wave/src)
    #ADD_SOURCE_DIRS(${BOOST_ROOT}/libs/wave/src/cpplexer/re2clex)
ENDIF()

INCLUDE($ENV{MK_PATH}/make/end.cmake)
