

Oracle体系结构简述
oracle 实例
instance=内存结构+服务进程
oracle 数据库
控制文件(control files)
重做日志文件(redo log files)
数据文件(data file)
归档重做日志文件(archived redo log files)
初始化参数文件(parameter files)
密码文件(password files)

oracle检查点scn
数据库恢复后，要使数据库正常打开，需保证各文件中的检查点scn一致
系统检查点scn(记录在控制文件中)
select checkpoint_change# from v$database;
数据文件检查点scn(记录在控制文件中)
select name,checkpoint_change# from v$datafile;
数据文件终止scn (记录在控制文件中)
select name,last_change# from v$datafile;
数据文件头启动scn(记录在数据文件中)
select file#,checkpoint_change# from v$datafile_header;

oracle启动检测原则
①数据库打开运行之后，系统检查点scn、数据文件检查点scn和数据文件头中启动scn都是相同的。
②控制文件中的每个数据文件的终止scn都为null。
③正常关闭数据库的过程中，系统会执行一个检查点动作，这时所有数据文件的终止scn 都会设置成数据文件头中的启动scn的值。
④在数据库重新启动的时，Oracle将执行两次检查。
    ◆ 查看数据文件头中的ckpt计数器(启动SCN)是否与对应控制文件中的ckpt计数器(数据文件检查点SCN)一致。若相等，进行第二次检查  。
    ◆ 比较文件头中的启动scn和对应控制文件中的数据文件终止scn进行比较，如果终止scn等于启动scn，则不需要对那个文件进行恢复。
⑤数据库打开之后，存储在控制文件中的数据文件终止scn的值再次被更改为null，这表示数据文件已经打开并能够正常使用了。


Oracle数据库RMAN介绍   
        Recovery Manager（RMAN）是一种用于备份(backup)、还原(restore)和恢复(recover)数据库的Oracle 工具。采用执行脚本的方式备份整个数据库或数据库部件，如表空间、数据文件、控制文件、归档文件以及Spfile参数文件。RMAN也支持增量数据块级别的备份，只备份自上次备份以来有变化的那些数据块。
        
        
Backup 原理
        Oracle 备份，分为热备份与冷备份，通常我们采用的是不停机的热备份来保证数据的安全。热备份的大致原理如下：
        1.执行命令：ALTER  DATABASE BEGIN BACKUP
        2.调用操作系统的复制工具复制该表空间下所有数据文件。
        3.执行命令：ALTER  DATABASE  END BACKUP    

BEGIN BACKUP 原理
        1.首先触发表空间上的检查点操作，强迫数据文件在备份开始时处于一致状态
        2.在每个数据文件头部设置了热备份模糊标志位，表明该数据文件处于热备份状态。标志的目的是冻结数据文件头部的检查点和数据文件的检查点（停留在begin backup命令发出那一刻的SCN）。这个值作用在于当备份被还原时，介质恢复能从足够早的SCN开始重新应用重做日志。      
  3.启用 HOT BACKUP SCN 接收原本属于被冻结的检查点该接收的更新
        4.热备份后开始数据块的前镜像记录。记录过程中，将所有实例将每个要修改块的完整的块而不是修改向量记录到重做日志中
        5.清除了数据文件的联机模糊位标志。

END BACKUP 原理
        1.还原数据文件的联机模糊标志位。
        2.在重做日志中写入该数据文件结束热备份的重做记录。记录热备份开始时刻的SCN（该SCN跟数据文件头部被冻结的检查点的SCN一致）。也标志着热备份期间的重做日志的结束。介质恢复时读到这个热备份结束标记，就知道热备份期间产生的重做日志都被应用到了数据文件上。
        3.清除热备份模糊标志位。这个标志位能防止不完全恢复错误的选择在BEGIN BACKUP和END BACKUP时间点之间停止，导致数据文件不一致。
        4.停止数据块前镜像记录。
        5.推进控制文件中数据文件的检查点和数据文件头检查点到HOT BACKUP SCN 记录的数据库最新检查点。

Restore 原理
        将oracle备份数据拷贝到数据库的过程。包括控制文件拷贝，然后根据控制文件来确认需要恢复备份片，最后将备份片中的数据文件拷贝到对应的数据文件中。

Recover 原理
        Recover就是restore归档日志和SMON进程应用归档日志的过程。
        如果是完全恢复，那么日志会应用到归档日志到重做日志中写入该数据文件结束热备份的重做记录中所记录的检查点SCN。
        如果是不完全恢复，那么日志至少是应用到这个点，然后继续应用日志到指定的时间点对应的SCN。
        应用归档日志分为前滚和回滚两个操作：
        前滚，指的是应用归档日志中记录的所有事务，将数据记录到数据文件中。
        回滚，指的是将未提交的事务中修改的并且已经写入磁盘的脏块块替换为Undo表空间中较早SCN的块。
        如果存在多个归档线程，那么首先会根据SCN进行日志的合并。
    
    
    AB备份恢复原理
        备份主要涉及4大模块，调度模块，数据传输模块，数据库信息查询模块，执行输出模块。
        首先调度模块调度脚本发起rman备份，rman将数据发送给数据传输模块，数据传输模块间数据传输给调度模块然后转发给介质。
        数据库信息查询模块主要负责信息的获取和确认。
        执行输出模块主要实时获取脚本的执行，显示到控制台。
        rman备份采用模拟带库的方式进行备份，oracle专门提供了一套接口，供第三方实现，第三方软件可以按照它的接口规则实现此模块。发起备份后oracle会调用此模块，进行数据的传递。相应的，第三方软件就可以获取到oracle传递过来的数据。
        
        
AB 数据传递方法
        在我们实现的数据传输模块中，我们采用管道来进行信号的收发和数据的传递。
        在此，我们定义了一套消息码，来实现调度模块和传输模块的交互。采用命名管道完成数据的传递。
    例如：首先调度管理模块新建管道等待连接，然后发起调度执行脚本，sbt连接管道，发送初始化管道连接的消息，确认连接成功。sbt发送备份的备份片名称，大小给调度管理模块，然后循环发送数据。调度管理模块接收到消息后申请空间循环接收数据。sbt发送完成后，发送end消息，然后发送新的备份片名称。如此循环，直到数据发送完毕。发送完毕后，sbt发送断开连接的请求，完成管道断开造作。至此，完成一次完整的交互。
多任务并行原理
        进程间利用命名管道交互，那么第一个问题就是如何约定管道名称。
        单任务执行可以采用指定的管道名，但多任务就无法解决管道名称的约定问题。
        在此我们采用了文件系统，配合进程PID的方式，实现多组进程间的配对问题。以解决无法并行的问题。
        我们采用两个进程PID组合管道名称的方法组成3元组，来记录已配对的进程，采用PID管道名和时间戳组成3元组，来记录等待连接的进程。
        分别使用初始化连接记录文件和以配对连接记录文件来分别记录等待连接的管道，和已经连接的管道。
并行任务调度原理
        以下为并行任务管道连接管理的系统结构图：
        
        
        
        
多通道并行备份
多通道并行备份的主要思路为开辟多个Rman channel来获取数据，从而达到更高的数据读取速度。同时在数据的传输和存储链路同样也实现多线程的并行数据传输和存储。以实现整体的备份恢复速度提升。
多通道备份可以将数据文件和日志文件分别分配到不同的数据通道中，并行的读取传输数据，从而充分利用磁盘I/O。以达到最优的备份速度。











  以下为并行任务管道连接管理的系统结构图：




多通道并行备份数据流




Oracle块跟踪修改
BCT原理
Block change tracking 会记录data file里每个block的update 信息，这些tracking信息保存在tracking 文件里。 当启动block change tracking 后，Rman 使用trackingfile里的信息，只读取改变的block信息，而不用再对整个data file进行扫描，从而提高了Rman 备份的性能。
在备份期间，change tracking会维护已经标记为change 的block 的bitmap 信息,Oracle 会自动管理change tracking file的大小，只保留最近最近8次block change 的信息。超过8次，那么最前面的block bitmap 信息会被current change 覆盖。第一个0级的增量备份扫描整个data file。 随后的增量备份使用block change tracking file的信息，只扫描自上次备份以来被标记为change 的block。
配置注意事项
1.change tracking file 路径自己指定， 但Oracle 不建议使用raw device 来存放change tracking file。 如果是RAC 环境，change tracking file 必须放在共享设备上。使所有的节点都能共享此文件。
2.Rman 不支持对change tracking file 的备份与恢复。当数据检测到change tracking file 无效时，就会reset change tracking file。 如果我们还原了数据库，那么数据库也会reset block change tracking，并重新进行tracking。
3.tracking file 的大小会根据数据库大小的变化而变化，和本身的更新频率没有关系。 单实例下此文件的大小大约为数据库大小的1/30000。 如果是RAC 环境，再乘以threads。也就是说：单实例下大约DB的1/30000的block 会被track。 如果是RAC 环境，再乘以threads。按此方法计算，如果数据库接近300G，那么tracking file 不能小于10M。理论上启用BCT后，不需要其他的维护操作。但是我们要保证存放此文件的磁盘有足够的空间供tracking文件进行自动扩展。
多样化参数配置
为了方便Rman性能调优，达到更加理想的备份速度， AnyBackup对Rman的参数提供了非常全面的支持。
  其中包括：Rman块大小，备份片容量，备份集数据文件个数，备份集日志文件个数，多路复用（ MAXOPENFILES ），跳过脱机文件，跳过只读表空间，跳过静态数据文件，数据库高级压缩，指定是否备份参数文件，备份指定时间段的归档日志，删除指定时间段的归档日志。
对于普通恢复，我们在尽量简化恢复操作的前提下，提供了多样化的参数配置，满足客户多样化的恢复需求。包括统一的数据文件重定向、按文件指定路径的重定、完全恢复、不完全恢复、是否恢复控制文件、恢复后是否联机。
